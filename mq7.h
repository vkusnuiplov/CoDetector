/**
  ******************************************************************************
  * @file    mq7.h
  * @author  vkusnuiplov
  * @brief   Заголовочний файл для роботи з датчиком CO MQ-7.
  * * Файл містить кінцевий автомат станів для керування датчиком MQ-7,
  * а також функції ініціалізації та обчислення результатів вимірювань.
  *
  ******************************************************************************
  */



#ifndef MQ7_H
#define MQ7_H

#include "main.h"   // Для доступу до типів HAL (GPIO_TypeDef)
#include <stdint.h> // Для стандартних типів uint32_t, float 

// --- 1. ENUM (Перелічення станів) ---
typedef enum {
    MQ7_STATE_HEATING_HIGH_5V,      // Фаза очистки (нагрів 5В)
    MQ7_STATE_HEATING_LOW_1_4V      // Фаза вимірювання (нагрів 1.4В)
} mq7_state_e;

// --- 2. STRUCT (Об'єкт датчика) ---
typedef struct {
    // ------- [HARDWARE] Прив'язка до заліза -------
    GPIO_TypeDef* heater_port;      // Порт керування нагрівачем
    uint32_t      heater_pin;       // Пін керування нагрівачем
    
    // ------- [CONFIG] Параметри плати та фізики -------
    float         sensor_vcc_v;     // Напруга живлення датчика (напр. 5.0f)
    float         adc_vref;         // Опорна напруга АЦП (напр. 3.3f)
    float         adc_max_val;      // Максимум АЦП (напр. 4095.0f)
    float         rl_value;         // Опір навантаження на платі (R_Load, Ом)
    float         ro_value;         // Опір чистого датчика (R0, Ом) - результат калібрування
    float         adc_step_v;       // Крок АЦП в В (напр. 3300/4095 = 0.0008V) 
    
    // ------- [TIME]конфігурація часових циклів (в мс) ------- 
    uint32_t cycle_duration_high_ms; // Тривалість фази нагріву 5В   (стандарт: 60000 мс)
    uint32_t cycle_duration_low_ms;  // Тривалість фази нагріву 1.4В (стандарт: 90000 мс)

    // ------- [MATH] Коефіцієнти кривої (PPM = a * ratio^b) -------
    float         curve_a;          // Множник (напр. 100.0f)
    float         curve_b;          // Степінь (напр. -1.43f)

    // ------- [DATA] Живі дані -------
    volatile uint32_t raw_adc_value; // Свіже значення АЦП (пише main, читає lib)
    float             current_ppm;   // Результат розрахунку

    // ------- [INTERNAL] Внутрішній стан -------
    mq7_state_e       state;           // Поточний стан FSM 
    uint32_t          timer_start_ms;  // Системний час (tick) входу в поточний стан

} mq7_t;

// --- 3. API (Публічні функції) ---

// Ініціалізація датчика та запуск першого циклу
void mq7_init(mq7_t *handle);

// Перемикання станів датчика - має викликатися в головному циклі програми
void mq7_process(mq7_t *handle, uint32_t current_time_ms);

// Отримання останнього розрахованого значення PPM
float mq7_get_ppm(mq7_t *handle);

#endif // MQ7_H